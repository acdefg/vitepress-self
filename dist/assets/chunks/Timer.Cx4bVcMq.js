import{_ as G,h as I,p as u,v as K,x as Y,q as H,o as b,c as B,j as c,t as y,F as E,C as Q,n as W,e as X,N as Z}from"./framework.CElktlHO.js";const $={props:{customTimes:{type:Object,default:()=>({pomodoro:25*60,shortBreak:5*60,longBreak:15*60})},currentUser:{type:Object,default:null}},emits:["update-stats"],setup(k,{emit:l}){const m=I(()=>[{value:"pomodoro",label:"专注",duration:k.customTimes.pomodoro,color:"#c45353"},{value:"shortBreak",label:"短休",duration:k.customTimes.shortBreak,color:"#38858a"},{value:"longBreak",label:"长休",duration:k.customTimes.longBreak,color:"#397097"}]),e=u("pomodoro"),v=u(m.value[0].duration),f=u(!1),n=u(null),i=u(0),N=u(0),g=u(!1),S=u(null),p=u(null),s=u(0);u(null);const O=u(null),h=u(!1),w=u(!0),d=u(!1),C=300,T=10,q=I(()=>{const o=Math.floor(v.value/60),t=v.value%60;return`${o.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}),A=I(()=>{const o=i.value,t=Math.floor(o/60),a=o%60;return`${t.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}),J=I(()=>{var o;return{backgroundColor:(o=m.value.find(t=>t.value===e.value))==null?void 0:o.color}}),R=async()=>{Notification.permission!=="granted"&&await Notification.requestPermission()},x=()=>{f.value?clearInterval(n.value):(p.value?d.value&&(p.value=Date.now()-i.value*1e3,console.log("second start with elapsed time:",i.value)):(p.value=Date.now(),i.value=0,s.value=0,N.value=m.value.find(o=>o.value===e.value).duration),n.value=setInterval(()=>{const o=Date.now();d.value?i.value=Math.floor((o-p.value)/1e3):(i.value=Math.floor((o-p.value)/1e3),v.value=N.value-i.value,v.value<=0&&z())},1e3)),f.value=!f.value},_=()=>{clearInterval(n.value),clearTimeout(S.value);const o=s.value+i.value,a=e.value==="shortBreak"||e.value==="longBreak"?o>=T:o>=C;h.value&&!w.value&&a&&(M(),l("update-stats")),f.value=!1,i.value=0,s.value=0,v.value=m.value.find(r=>r.value===e.value).duration,N.value=v.value,p.value=null,g.value=!1,h.value=!1,w.value=!0,d.value=!1},D=o=>{if(s.value>0||i.value>0){const t=s.value+i.value;(e.value==="shortBreak"||e.value==="longBreak"?t>=T:t>=C)&&(M(),l("update-stats"))}e.value=o,_()},U=()=>{const o=new(window.AudioContext||window.webkitAudioContext),t=o.createOscillator(),a=o.createGain();return t.connect(a),a.connect(o.destination),t.type="sine",t.frequency.value=880,a.gain.value=.1,{play:()=>{t.start(o.currentTime),setTimeout(()=>{t.stop(),t.disconnect(),a.disconnect()},200)}}},j=async()=>{console.log("Playing notification beeps");let o=0;const t=async()=>{if(o<3)try{U().play(),o++,console.log("Played beep:",o),o<3&&setTimeout(t,500)}catch(a){console.error("Error playing beep:",a)}};await t()},z=()=>{clearInterval(n.value),f.value=!1,h.value=!0,w.value=!1,s.value+=i.value,console.log("Timer completed:",{mode:e.value,elapsed:i.value,accumulated:s.value}),d.value=!0,Notification.permission==="granted"&&new Notification("番茄钟提醒",{body:`${e.value==="pomodoro"?"专注":"休息"}时间结束！`,icon:"/favicon.ico"}),j(),g.value=!0,S.value=setTimeout(()=>{g.value&&F()},3e4)},L=()=>{const o=s.value+i.value;(e.value==="shortBreak"||e.value==="longBreak"?o>=T:o>=C)&&(M(),l("update-stats")),_(),d.value=!1,s.value=0,g.value=!1},F=()=>{g.value=!1,clearTimeout(S.value),d.value||(d.value=!0),p.value=Date.now(),x()},V=o=>{g.value=!1,clearTimeout(S.value);const t=s.value+i.value;(e.value==="shortBreak"||e.value==="longBreak"?t>=T:t>=C)&&(M(),l("update-stats")),D(o),d.value=!1,x()},M=()=>{var P;if(s.value===0)return;const o=new Date,t=`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`;console.log("Saving stats for date:",t);const a=((P=k.currentUser)==null?void 0:P.id)||"anonymous";let r=JSON.parse(a==="anonymous"?localStorage.getItem("anonymous_stats")||"{}":localStorage.getItem(`stats_${a}`)||"{}");r[t]||(r[t]={pomodoro:0,shortBreak:0,longBreak:0,focusMinutes:0,breakMinutes:0,totalMinutes:0}),e.value==="pomodoro"&&s.value>=C?(r[t].pomodoro++,r[t].focusMinutes+=Math.floor(s.value/60)):e.value==="shortBreak"&&s.value>=T?(r[t].shortBreak++,r[t].breakMinutes+=Math.floor(s.value/60)):e.value==="longBreak"&&s.value>=T&&(r[t].longBreak++,r[t].breakMinutes+=Math.floor(s.value/60)),r[t].totalMinutes=r[t].focusMinutes+r[t].breakMinutes,console.log("Updated stats:",r[t]),a==="anonymous"?(localStorage.setItem("anonymous_stats",JSON.stringify(r)),localStorage.setItem("anonymous_stats_date",t)):localStorage.setItem(`stats_${a}`,JSON.stringify(r)),l("update-stats")};return K(async()=>{await R();const o=localStorage.getItem("pomodoroMode")||"pomodoro";e.value=o,_()}),Y(()=>{h.value&&!w.value&&(e.value==="pomodoro"?s.value>=300&&M():M()),clearInterval(n.value),clearTimeout(S.value),O.value&&O.value.close()}),H(()=>k.customTimes,o=>{const t=m.value.find(a=>a.value===e.value);t&&(v.value=t.duration)},{deep:!0}),{modes:m,currentMode:e,timeLeft:v,isRunning:f,formattedTime:q,containerStyle:J,toggleTimer:x,resetTimer:_,switchMode:D,showContinuePrompt:g,handleContinue:F,handleNext:V,elapsedTime:i,targetTime:N,accumulatedTime:s,sessionComplete:h,lastSessionSaved:w,isForwardTiming:d,formatForwardTime:A,handleStop:L}}},ee={class:"timer-display"},te={class:"mode-selector"},oe=["onClick"],ae={class:"controls"},le={key:0,class:"continue-prompt"},ne={class:"prompt-buttons"};function se(k,l,m,e,v,f){return b(),B("div",{class:"timer-container",style:Z(e.containerStyle)},[c("div",ee,y(e.isForwardTiming?e.formatForwardTime:e.formattedTime),1),c("div",te,[(b(!0),B(E,null,Q(e.modes,n=>(b(),B("button",{key:n.value,onClick:i=>e.switchMode(n.value),class:W(["mode-btn",{active:e.currentMode===n.value}])},y(n.label),11,oe))),128))]),c("div",ae,[c("button",{onClick:l[0]||(l[0]=(...n)=>e.toggleTimer&&e.toggleTimer(...n)),class:"start-btn"},y(e.isRunning?"暂停":"开始"),1),c("button",{onClick:l[1]||(l[1]=(...n)=>e.resetTimer&&e.resetTimer(...n)),class:"reset-btn"},y(e.isForwardTiming?"停止":"重置"),1)]),e.showContinuePrompt?(b(),B("div",le,[c("p",null,y(e.currentMode==="pomodoro"?"专注":"休息")+"时间结束！",1),c("p",null,"累计时间："+y(Math.floor(e.accumulatedTime/60))+"分钟",1),c("div",ne,[c("button",{onClick:l[2]||(l[2]=(...n)=>e.handleStop&&e.handleStop(...n)),class:"stop-btn"},"停止"),c("button",{onClick:l[3]||(l[3]=(...n)=>e.handleContinue&&e.handleContinue(...n)),class:"continue-btn"},"继续"),e.currentMode==="pomodoro"?(b(),B(E,{key:0},[c("button",{onClick:l[4]||(l[4]=()=>e.handleNext("shortBreak")),class:"break-btn"},"短休息"),c("button",{onClick:l[5]||(l[5]=()=>e.handleNext("longBreak")),class:"break-btn"},"长休息")],64)):(b(),B("button",{key:1,onClick:l[6]||(l[6]=n=>e.handleNext("pomodoro")),class:"next-btn"},"开始专注"))])])):X("",!0)],4)}const ie=G($,[["render",se],["__scopeId","data-v-2dbed908"]]);export{ie as default};
