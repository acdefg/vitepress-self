import{_ as be,p as d,h as ye,v as X,x as ge,q as _e,a2 as F,a3 as Ce,o as c,c as v,j as s,a as xe,ab as ke,F as O,C as A,n as U,N as V,t as r,a9 as H,e as b,a0 as we}from"./framework.CElktlHO.js";const Me={class:"modal-dialog modal-fullscreen-md-down modal-xl"},We={class:"modal-content"},Ie={class:"modal-header"},Se={class:"modal-body wish-wall-container"},$e={class:"controls-container"},De={class:"wish-controls"},Fe={class:"filter-controls"},Ue={class:"switch"},ze=["data-expandable"],Ee=["data-active","onClick"],Be={class:"wish-content"},Ne={class:"wish-text"},Oe={class:"wish-footer"},Ae={class:"wish-user"},Ve={class:"wish-date"},Pe={key:0,class:"modal-form"},Re={class:"form-content"},Ye={class:"form-group mb-3"},je={class:"priority-selector"},qe=["onClick"],Je={class:"char-count"},Te={class:"form-buttons"},Xe=["disabled"],He={key:1,class:"modal-form"},Le={class:"form-content"},Ge={class:"original-wish mb-3"},Ke={class:"char-count"},Qe={key:2,class:"modal-form"},Ze={class:"form-content"},et={class:"wish-detail"},tt={class:"wish-detail-content"},lt={key:0,class:"priority-edit"},st={class:"priority-selector"},ot=["onClick"],nt={key:1,class:"fulfill-content"},at={class:"wish-meta"},it={key:0,class:"fulfill-date"},rt={class:"form-buttons"},ut={__name:"WishWallModal",props:{show:Boolean,currentUser:Object},setup(z){const m=z,i=d([]),g=d(null),W=d(!1),_=d(!1),p=d(""),y=d(""),n=d(null),E=d(!0),C=d("normal"),P=[{value:"low",label:"低",color:"#D4C8BE"},{value:"normal",label:"中",color:"#C8ADA0"},{value:"high",label:"高",color:"#AD8A83"}],x=ye(()=>E.value?i.value:i.value.filter(t=>!t.fulfilled));X(()=>{R();const t=document.querySelector(".modal");t&&(t.style.animation="modalFadeIn 0.3s ease forwards")}),ge(()=>{});const R=()=>{const t=localStorage.getItem("wishBullets");t&&(i.value=JSON.parse(t))},I=d({width:800,height:600}),u=d(new Map),L=t=>({width:200,height:120}),G=(t,e,o,l,a)=>{for(const[f,h]of u.value.entries()){if(f===a)continue;if(!(t+o<h.x||t>h.x+h.width||e+l<h.y||e>h.y+h.height))return!0}return!1},k=d(0),w=t=>{const{width:e,height:o}=L(t.priority),l=I.value.width,a=I.value.height,f=20,h=Math.floor((l-f*2)/(e+f)),j=()=>{const fe=u.value.size<5?.3:.7,he=l/2,me=a/2,J=Math.random()*Math.PI*2,pe=Math.min(l/3,a/3)*fe,T=Math.random()*pe;let $=he+T*Math.cos(J)-e/2,D=me+T*Math.sin(J)-o/2;return $+=(Math.random()-.5)*20,D+=(Math.random()-.5)*20,$=Math.max(f,Math.min($,l-e-f)),D=Math.max(f,Math.min(D,a-o-f)),{x:$,y:D}};let q=0;const de=50;for(;q<de;){const M=j();if(!G(M.x,M.y,e,o,t.id))return{x:M.x,y:M.y,width:e,height:o,rotation:(Math.random()-.5)*8};q++}const ce=k.value%h,ve=Math.floor(k.value/h);return k.value++,{x:f+ce*(e+f),y:f+ve*(o+f),width:e,height:o,rotation:0}},K=t=>{if(!u.value.has(t.id)){const a=w(t);a&&u.value.set(t.id,a)}const e=u.value.get(t.id);if(!e)return{};const o=N.value===t.id;let l=1;return t.priority==="high"?l=30:t.priority==="normal"?l=20:l=10,t.priority==="high"&&!o&&(l=40),{position:"absolute",left:`${e.x}px`,top:`${e.y}px`,width:`${e.width}px`,height:`${e.height}px`,transform:`rotate(${e.rotation}deg)`,transition:"all 0.3s ease",zIndex:o?100:l,cursor:"pointer"}};_e(()=>x.value,t=>{k.value=0,u.value.clear(),t.forEach(e=>{const o=w(e);o&&u.value.set(e.id,o)})},{deep:!0});const Y=()=>{if(!g.value)return;const e=g.value.getBoundingClientRect(),o=Math.min(1200,e.width);I.value={width:o,height:Math.max(600,e.height),expandable:!1,centerX:o/2,centerY:e.height/2},u.value.clear(),x.value.forEach(l=>{const a=w(l);a&&u.value.set(l.id,a)})};X(()=>{console.log("Component mounted"),R(),Y(),k.value=0;const t=new ResizeObserver(()=>{console.log("Container resized"),Y(),u.value.clear(),x.value.forEach(e=>{const o=w(e);o&&u.value.set(e.id,o)})});return g.value&&t.observe(g.value),()=>{t.disconnect()}});const B=t=>{if(!t)return"";const e=new Date(t);return`${e.getFullYear()}年${e.getMonth()+1}月${e.getDate()}日`},Q=()=>Date.now()+Math.floor(Math.random()*1e3),Z=()=>{var e,o;if(!p.value.trim())return;const t={id:Q(),type:"wish",content:p.value,user:((e=m.currentUser)==null?void 0:e.username)||"匿名",userId:((o=m.currentUser)==null?void 0:o.id)||"anonymous",date:new Date().toISOString(),fulfilled:!1,priority:C.value};i.value.push(t),S(),p.value="",C.value="normal",W.value=!1},ee=()=>{if(!n.value)return;const t=i.value.findIndex(e=>e.id===n.value.id);t!==-1&&(i.value[t]={...i.value[t],fulfilled:!0,fulfillContent:y.value.trim(),fulfillDate:new Date().toISOString()},S(),y.value="",_.value=!1,n.value=i.value[t])},S=()=>{localStorage.setItem("wishBullets",JSON.stringify(i.value))},te=t=>{N.value=t.id,n.value=t},le=t=>m.currentUser&&t.userId===m.currentUser.id,se=t=>m.currentUser&&t.userId===m.currentUser.id&&!t.fulfilled&&t.type==="wish",oe=t=>{i.value=i.value.filter(e=>e.id!==t.id),S(),n.value=null},ne=()=>{_.value=!0},ae=()=>{p.value="",C.value="normal",W.value=!1},ie=()=>{y.value="",_.value=!1},N=d(null),re=(t,e)=>{const o=i.value.findIndex(l=>l.id===t.id);o!==-1&&(i.value[o]={...i.value[o],priority:e},S(),n.value=i.value[o],u.value.clear(),x.value.forEach(l=>{const a=w(l);a&&u.value.set(l.id,a)}))},ue=t=>m.currentUser&&t.userId===m.currentUser.id&&!t.fulfilled;return(t,e)=>{var o;return F((c(),v("div",{class:U(["modal",{show:z.show}]),tabindex:"-1",onClick:e[7]||(e[7]=we((...l)=>t.handleClose&&t.handleClose(...l),["self"]))},[s("div",Me,[s("div",We,[s("div",Ie,[e[8]||(e[8]=s("h5",{class:"modal-title"},"愿望墙",-1)),s("button",{type:"button",class:"btn-close",onClick:e[0]||(e[0]=l=>t.$emit("close")),"aria-label":"Close"})]),s("div",Se,[s("div",$e,[s("div",De,[s("button",{onClick:e[1]||(e[1]=l=>W.value=!0),class:"btn btn-primary"},e[9]||(e[9]=[s("i",{class:"fa fa-star"},null,-1),xe("许愿 ")])),s("div",Fe,[s("label",Ue,[F(s("input",{type:"checkbox","onUpdate:modelValue":e[2]||(e[2]=l=>E.value=l)},null,512),[[ke,E.value]]),e[10]||(e[10]=s("span",{class:"slider round"},null,-1))]),e[11]||(e[11]=s("span",{class:"filter-label"},"显示已还愿",-1))])])]),s("div",{ref_key:"wishContainer",ref:g,class:"wish-container","data-expandable":I.value.expandable},[(c(!0),v(O,null,A(x.value,l=>(c(),v("div",{key:l.id,class:U(["wish-bullet",[l.type,l.fulfilled?"fulfilled":"",l.priority,l.isNew?"isNew":""]]),style:V(K(l)),"data-active":N.value===l.id,onClick:a=>te(l)},[s("div",Be,[s("p",Ne,r(l.content),1),s("div",Oe,[s("span",Ae,r(l.user),1),s("span",Ve,r(B(l.date)),1)])])],14,Ee))),128))],8,ze)])])]),W.value?(c(),v("div",Pe,[s("div",Re,[e[13]||(e[13]=s("h3",null,"许下你的愿望",-1)),F(s("textarea",{"onUpdate:modelValue":e[3]||(e[3]=l=>p.value=l),class:"form-control mb-3",placeholder:"写下你的愿望...",maxlength:"50"},null,512),[[H,p.value]]),s("div",Ye,[e[12]||(e[12]=s("label",{class:"form-label"},"选择优先级",-1)),s("div",je,[(c(),v(O,null,A(P,l=>s("div",{class:U(["priority-option",{active:C.value===l.value}]),key:l.value,style:V({backgroundColor:l.color}),onClick:a=>C.value=l.value},r(l.label),15,qe)),64))])]),s("div",Je,r(p.value.length)+"/50",1),s("div",Te,[s("button",{onClick:ae,class:"btn btn-secondary"},"取消"),s("button",{onClick:Z,class:"btn btn-primary",disabled:!p.value.trim()}," 确认 ",8,Xe)])])])):b("",!0),_.value?(c(),v("div",He,[s("div",Le,[e[15]||(e[15]=s("h3",null,"分享你的成功",-1)),s("div",Ge,[e[14]||(e[14]=s("h5",null,"原愿望:",-1)),s("p",null,r((o=n.value)==null?void 0:o.content),1)]),F(s("textarea",{"onUpdate:modelValue":e[4]||(e[4]=l=>y.value=l),class:"form-control mb-3",placeholder:"分享你的故事（可选）...",maxlength:"50"},null,512),[[H,y.value]]),s("div",Ke,r(y.value.length)+"/50",1),s("div",{class:"form-buttons"},[s("button",{onClick:ie,class:"btn btn-secondary"},"取消"),s("button",{onClick:ee,class:"btn btn-primary"}," 确认还愿 ")])])])):b("",!0),n.value&&!_.value?(c(),v("div",Qe,[s("div",Ze,[s("h3",null,r(n.value.fulfilled?"已还愿":"愿望详情"),1),s("div",et,[s("p",tt,r(n.value.content),1),ue(n.value)?(c(),v("div",lt,[e[16]||(e[16]=s("label",{class:"form-label"},"修改优先级",-1)),s("div",st,[(c(),v(O,null,A(P,l=>s("div",{key:l.value,class:U(["priority-option",{active:n.value.priority===l.value}]),style:V({backgroundColor:l.color}),onClick:a=>re(n.value,l.value)},r(l.label),15,ot)),64))])])):b("",!0),n.value.fulfillContent?(c(),v("div",nt,[e[17]||(e[17]=s("h5",null,"还愿记录:",-1)),s("p",null,r(n.value.fulfillContent),1)])):b("",!0),s("div",at,[s("span",null,r(n.value.user),1),s("span",null,"许愿时间："+r(B(n.value.date)),1),n.value.fulfilled?(c(),v("span",it," 还愿时间："+r(B(n.value.fulfillDate)),1)):b("",!0)])]),s("div",rt,[s("button",{onClick:e[5]||(e[5]=l=>n.value=null),class:"btn btn-secondary"},"关闭"),se(n.value)?(c(),v("button",{key:0,onClick:ne,class:"btn btn-success"}," 还愿 ")):b("",!0),le(n.value)?(c(),v("button",{key:1,onClick:e[6]||(e[6]=l=>oe(n.value)),class:"btn btn-danger"}," 删除 ")):b("",!0)])])])):b("",!0)],2)),[[Ce,z.show]])}}},ct=be(ut,[["__scopeId","data-v-733bb0b1"]]);export{ct as default};
