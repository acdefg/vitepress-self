import{_ as H,h as x,p as i,v as Q,x as W,q as X,o as b,c as B,j as c,t as h,F as R,C as Z,n as $,e as ee,N as oe}from"./framework.CElktlHO.js";const te={props:{customTimes:{type:Object,default:()=>({pomodoro:25*60,shortBreak:5*60,longBreak:15*60})},currentUser:{type:Object,default:null}},emits:["update-stats"],setup(p,{emit:a}){const f=x(()=>[{value:"pomodoro",label:"专注",duration:p.customTimes.pomodoro,color:"#c45353"},{value:"shortBreak",label:"短休",duration:p.customTimes.shortBreak,color:"#38858a"},{value:"longBreak",label:"长休",duration:p.customTimes.longBreak,color:"#397097"}]),e=i("pomodoro"),v=i(f.value[0].duration),m=i(!1),n=i(null),s=i(0),N=i(0),g=i(!1),y=i(null),k=i(null),r=i(0);i(null);const F=i(null),I=i(!1),w=i(!0),d=i(!1),S=300,C=10,j=x(()=>{const o=Math.floor(v.value/60),t=v.value%60;return`${o.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}),U=x(()=>{const o=s.value,t=Math.floor(o/60),l=o%60;return`${t.toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}`}),z=x(()=>{var o;return{backgroundColor:(o=f.value.find(t=>t.value===e.value))==null?void 0:o.color}}),P=async()=>{console.log("请求通知权限"),Notification.permission!=="granted"&&Notification.requestPermission().then(o=>{console.log("用户权限:",o)})},D=()=>{m.value?clearInterval(n.value):(k.value?d.value&&(k.value=Date.now()-s.value*1e3,console.log("second start with elapsed time:",s.value)):(k.value=Date.now(),s.value=0,r.value=0,N.value=f.value.find(o=>o.value===e.value).duration),n.value=setInterval(()=>{const o=Date.now();d.value?s.value=Math.floor((o-k.value)/1e3):(s.value=Math.floor((o-k.value)/1e3),v.value=N.value-s.value,v.value<=0&&L())},1e3)),m.value=!m.value,P(),console.log("Toggle timer:",m.value)},_=()=>{clearInterval(n.value),clearTimeout(y.value);const o=r.value+s.value,l=e.value==="shortBreak"||e.value==="longBreak"?o>=C:o>=S;!w.value&&l&&(T(),a("update-stats")),m.value=!1,s.value=0,r.value=0,v.value=f.value.find(M=>M.value===e.value).duration,N.value=v.value,k.value=null,g.value=!1,I.value=!1,w.value=!0,d.value=!1},E=o=>{if(r.value>0||s.value>0){const t=r.value+s.value;(e.value==="shortBreak"||e.value==="longBreak"?t>=C:t>=S)&&(T(),a("update-stats"))}e.value=o,_()},J=()=>{const o=new(window.AudioContext||window.webkitAudioContext),t=o.createOscillator(),l=o.createGain();return t.connect(l),l.connect(o.destination),t.type="sine",t.frequency.value=880,l.gain.value=.1,{play:()=>{t.start(o.currentTime),setTimeout(()=>{t.stop(),t.disconnect(),l.disconnect()},200)}}},K=async()=>{console.log("Playing notification beeps");let o=0;const t=async()=>{if(o<3)try{J().play(),o++,console.log("Played beep:",o),o<3&&setTimeout(t,500)}catch(l){console.error("Error playing beep:",l)}};await t()},L=()=>{clearInterval(n.value),m.value=!1,I.value=!0,w.value=!1,r.value+=s.value,console.log("Timer completed:",{mode:e.value,elapsed:s.value,accumulated:r.value}),d.value=!0,Y(),K(),g.value=!0,y.value=setTimeout(()=>{g.value&&q()},3e4)},V=()=>{const o=r.value+s.value;(e.value==="shortBreak"||e.value==="longBreak"?o>=C:o>=S)&&(T(),a("update-stats")),_(),d.value=!1,r.value=0,g.value=!1},q=()=>{g.value=!1,clearTimeout(y.value),d.value||(d.value=!0),k.value=Date.now(),D()},G=o=>{g.value=!1,clearTimeout(y.value);const t=r.value+s.value;(e.value==="shortBreak"||e.value==="longBreak"?t>=C:t>=S)&&(T(),a("update-stats")),E(o),d.value=!1,D()},T=()=>{var A;if(r.value===0)return;const o=new Date,t=`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`,l=((A=p.currentUser)==null?void 0:A.id)||"anonymous",M=l==="anonymous"?"anonymous_stats":`stats_${l}`;let u=JSON.parse(localStorage.getItem(M)||"{}");u[t]||(u[t]={pomodoro:0,shortBreak:0,longBreak:0,focusMinutes:0,breakMinutes:0,totalMinutes:0}),console.log("Saving accumulated stats:",{userId:l,today:t,currentMode:e.value,accumulatedTime:r.value});const O=Math.floor(r.value/60);e.value==="pomodoro"&&r.value>=S?(u[t].pomodoro++,u[t].focusMinutes+=O):r.value>=C&&(e.value==="shortBreak"?(u[t].shortBreak++,u[t].breakMinutes+=O):e.value==="longBreak"&&(u[t].longBreak++,u[t].breakMinutes+=O)),u[t].totalMinutes=u[t].focusMinutes+u[t].breakMinutes,localStorage.setItem(M,JSON.stringify(u)),a("update-stats",u)},Y=async()=>{if(await P())try{new Notification("番茄钟提醒",{body:`${e.value==="pomodoro"?"专注":"休息"}时间结束！`,icon:"/icons/tomato.png"})}catch(t){console.error("发送通知时出错:",t)}};return Q(async()=>{await P();const o=localStorage.getItem("pomodoroMode")||"pomodoro";e.value=o,_()}),W(()=>{I.value&&!w.value&&(e.value==="pomodoro"?r.value>=300&&T():T()),clearInterval(n.value),clearTimeout(y.value),F.value&&F.value.close()}),X(()=>p.customTimes,o=>{const t=f.value.find(l=>l.value===e.value);t&&(v.value=t.duration)},{deep:!0}),{modes:f,currentMode:e,timeLeft:v,isRunning:m,formattedTime:j,containerStyle:z,toggleTimer:D,resetTimer:_,switchMode:E,showContinuePrompt:g,handleContinue:q,handleNext:G,elapsedTime:s,targetTime:N,accumulatedTime:r,sessionComplete:I,lastSessionSaved:w,isForwardTiming:d,formatForwardTime:U,handleStop:V}}},ae={class:"timer-display"},le={class:"mode-selector"},ne=["onClick"],se={class:"controls"},re={key:0,class:"continue-prompt"},ie={class:"prompt-buttons"};function ue(p,a,f,e,v,m){return b(),B("div",{class:"timer-container",style:oe(e.containerStyle)},[c("div",ae,h(e.isForwardTiming?e.formatForwardTime:e.formattedTime),1),c("div",le,[(b(!0),B(R,null,Z(e.modes,n=>(b(),B("button",{key:n.value,onClick:s=>e.switchMode(n.value),class:$(["mode-btn",{active:e.currentMode===n.value}])},h(n.label),11,ne))),128))]),c("div",se,[c("button",{onClick:a[0]||(a[0]=(...n)=>e.toggleTimer&&e.toggleTimer(...n)),class:"start-btn"},h(e.isRunning?"暂停":"开始"),1),c("button",{onClick:a[1]||(a[1]=(...n)=>e.resetTimer&&e.resetTimer(...n)),class:"reset-btn"},h(e.isForwardTiming?"停止":"重置"),1)]),e.showContinuePrompt?(b(),B("div",re,[c("p",null,h(e.currentMode==="pomodoro"?"专注":"休息")+"时间结束！",1),c("p",null,"累计时间："+h(Math.floor(e.accumulatedTime/60))+"分钟",1),c("div",ie,[c("button",{onClick:a[2]||(a[2]=(...n)=>e.handleStop&&e.handleStop(...n)),class:"stop-btn"},"停止"),c("button",{onClick:a[3]||(a[3]=(...n)=>e.handleContinue&&e.handleContinue(...n)),class:"continue-btn"},"继续"),e.currentMode==="pomodoro"?(b(),B(R,{key:0},[c("button",{onClick:a[4]||(a[4]=()=>e.handleNext("shortBreak")),class:"break-btn"},"短休息"),c("button",{onClick:a[5]||(a[5]=()=>e.handleNext("longBreak")),class:"break-btn"},"长休息")],64)):(b(),B("button",{key:1,onClick:a[6]||(a[6]=n=>e.handleNext("pomodoro")),class:"next-btn"},"开始专注"))])])):ee("",!0)],4)}const ve=H(te,[["render",ue],["__scopeId","data-v-296029b9"]]);export{ve as default};
