import{_ as Y,h as x,p as i,v as Q,x as W,q as X,o as b,c as h,j as c,t as y,F as A,C as Z,n as $,e as ee,N as oe}from"./framework.CElktlHO.js";const te={props:{customTimes:{type:Object,default:()=>({pomodoro:25*60,shortBreak:5*60,longBreak:15*60})},currentUser:{type:Object,default:null}},emits:["update-stats"],setup(T,{emit:n}){const g=x(()=>[{value:"pomodoro",label:"专注",duration:T.customTimes.pomodoro,color:"#c45353"},{value:"shortBreak",label:"短休",duration:T.customTimes.shortBreak,color:"#38858a"},{value:"longBreak",label:"长休",duration:T.customTimes.longBreak,color:"#397097"}]),e=i("pomodoro"),v=i(g.value[0].duration),m=i(!1),s=i(null),l=i(0),N=i(0),f=i(!1),w=i(null),k=i(null),r=i(0);i(null);const F=i(null),I=i(!1),p=i(!0),d=i(!1),M=300,S=10,j=x(()=>{const o=Math.floor(v.value/60),t=v.value%60;return`${o.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}),U=x(()=>{const o=l.value,t=Math.floor(o/60),a=o%60;return`${t.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}),z=x(()=>{var o;return{backgroundColor:(o=g.value.find(t=>t.value===e.value))==null?void 0:o.color}}),P=async()=>{console.log("请求通知权限"),Notification.permission!=="granted"&&Notification.requestPermission().then(o=>{console.log("用户权限:",o)})},D=()=>{m.value?clearInterval(s.value):(k.value?d.value&&(k.value=Date.now()-l.value*1e3,console.log("second start with elapsed time:",l.value),console.log("accumulated time:",r.value)):(k.value=Date.now(),l.value=0,r.value=0,N.value=g.value.find(o=>o.value===e.value).duration),s.value=setInterval(()=>{const o=Date.now();d.value?l.value=Math.floor((o-k.value)/1e3):(l.value=Math.floor((o-k.value)/1e3),v.value=N.value-l.value,v.value<=0&&L())},1e3)),m.value=!m.value,P(),console.log("Toggle timer:",m.value)},_=()=>{clearInterval(s.value),clearTimeout(w.value);const o=r.value+l.value;console.log("Resetting timer:",{mode:e.value,elapsed:l.value,accumulated:r.value});const a=e.value==="shortBreak"||e.value==="longBreak"?o>=S:o>=M;!p.value&&a&&(console.log("Saving stats on reset"),C(),n("update-stats")),m.value=!1,l.value=0,r.value=0,v.value=g.value.find(B=>B.value===e.value).duration,N.value=v.value,k.value=null,f.value=!1,I.value=!1,p.value=!0,d.value=!1},E=o=>{if(r.value>0||l.value>0){const t=r.value+l.value;(e.value==="shortBreak"||e.value==="longBreak"?t>=S:t>=M)&&(console.log("Saving stats on mode switch"),C(),n("update-stats"))}e.value=o,_()},J=()=>{const o=new(window.AudioContext||window.webkitAudioContext),t=o.createOscillator(),a=o.createGain();return t.connect(a),a.connect(o.destination),t.type="sine",t.frequency.value=880,a.gain.value=.1,{play:()=>{t.start(o.currentTime),setTimeout(()=>{t.stop(),t.disconnect(),a.disconnect()},200)}}},K=async()=>{console.log("Playing notification beeps");let o=0;const t=async()=>{if(o<3)try{J().play(),o++,console.log("Played beep:",o),o<3&&setTimeout(t,500)}catch(a){console.error("Error playing beep:",a)}};await t()},L=()=>{clearInterval(s.value),m.value=!1,I.value=!0,p.value=!1,r.value+=l.value,console.log("Timer completed:",{mode:e.value,elapsed:l.value,accumulated:r.value}),d.value=!0,H(),K(),f.value=!0,w.value=setTimeout(()=>{f.value&&R()},3e4)},V=()=>{const o=r.value+l.value;(e.value==="shortBreak"||e.value==="longBreak"?o>=S:o>=M)&&!p.value&&(console.log("Saving stats on stop"),C(),n("update-stats"),p.value=!0),_(),d.value=!1,r.value=0,f.value=!1},R=()=>{f.value=!1,clearTimeout(w.value),d.value||(d.value=!0),k.value=Date.now(),D()},G=o=>{f.value=!1,clearTimeout(w.value);const t=r.value+l.value;(e.value==="shortBreak"||e.value==="longBreak"?t>=S:t>=M)&&(console.log("Saving stats on mode change"),C(),n("update-stats")),E(o),d.value=!1,D()},C=()=>{var q;if(r.value===0)return;const o=new Date,t=`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`,a=((q=T.currentUser)==null?void 0:q.id)||"anonymous",B=a==="anonymous"?"anonymous_stats":`stats_${a}`;let u=JSON.parse(localStorage.getItem(B)||"{}");u[t]||(u[t]={pomodoro:0,shortBreak:0,longBreak:0,focusMinutes:0,breakMinutes:0,totalMinutes:0}),console.log("Saving accumulated stats:",{userId:a,today:t,time:`${o.getHours().toString().padStart(2,"0")}:${o.getMinutes().toString().padStart(2,"0")}:${o.getSeconds().toString().padStart(2,"0")}`,currentMode:e.value,accumulatedTime:r.value,elapsedTime:l.value});const O=Math.floor(l.value/60);e.value==="pomodoro"&&r.value>=M?(u[t].pomodoro++,u[t].focusMinutes+=O):r.value>=S&&(e.value==="shortBreak"?(u[t].shortBreak++,u[t].breakMinutes+=O):e.value==="longBreak"&&(u[t].longBreak++,u[t].breakMinutes+=O)),u[t].totalMinutes=u[t].focusMinutes+u[t].breakMinutes,localStorage.setItem(B,JSON.stringify(u)),n("update-stats",u)},H=async()=>{if(await P())try{new Notification("番茄钟提醒",{body:`${e.value==="pomodoro"?"专注":"休息"}时间结束！`,icon:"/icons/tomato.png"})}catch(t){console.error("发送通知时出错:",t)}};return Q(async()=>{await P();const o=localStorage.getItem("pomodoroMode")||"pomodoro";e.value=o,_()}),W(()=>{if(I.value&&!p.value){console.log("Saving stats on unmount");const o=r.value;(e.value==="shortBreak"||e.value==="longBreak"?o>=S:o>=M)&&C()}clearInterval(s.value),clearTimeout(w.value),F.value&&F.value.close()}),X(()=>T.customTimes,o=>{const t=g.value.find(a=>a.value===e.value);t&&(v.value=t.duration)},{deep:!0}),{modes:g,currentMode:e,timeLeft:v,isRunning:m,formattedTime:j,containerStyle:z,toggleTimer:D,resetTimer:_,switchMode:E,showContinuePrompt:f,handleContinue:R,handleNext:G,elapsedTime:l,targetTime:N,accumulatedTime:r,sessionComplete:I,lastSessionSaved:p,isForwardTiming:d,formatForwardTime:U,handleStop:V}}},ae={class:"timer-display"},ne={class:"mode-selector"},le=["onClick"],se={class:"controls"},re={key:0,class:"continue-prompt"},ie={class:"prompt-buttons"};function ue(T,n,g,e,v,m){return b(),h("div",{class:"timer-container",style:oe(e.containerStyle)},[c("div",ae,y(e.isForwardTiming?e.formatForwardTime:e.formattedTime),1),c("div",ne,[(b(!0),h(A,null,Z(e.modes,s=>(b(),h("button",{key:s.value,onClick:l=>e.switchMode(s.value),class:$(["mode-btn",{active:e.currentMode===s.value}])},y(s.label),11,le))),128))]),c("div",se,[c("button",{onClick:n[0]||(n[0]=(...s)=>e.toggleTimer&&e.toggleTimer(...s)),class:"start-btn"},y(e.isRunning?"暂停":"开始"),1),c("button",{onClick:n[1]||(n[1]=(...s)=>e.resetTimer&&e.resetTimer(...s)),class:"reset-btn"},y(e.isForwardTiming?"停止":"重置"),1)]),e.showContinuePrompt?(b(),h("div",re,[c("p",null,y(e.currentMode==="pomodoro"?"专注":"休息")+"时间结束！",1),c("p",null,"累计时间："+y(Math.floor(e.accumulatedTime/60))+"分钟",1),c("div",ie,[c("button",{onClick:n[2]||(n[2]=(...s)=>e.handleStop&&e.handleStop(...s)),class:"stop-btn"},"停止"),c("button",{onClick:n[3]||(n[3]=(...s)=>e.handleContinue&&e.handleContinue(...s)),class:"continue-btn"},"继续"),e.currentMode==="pomodoro"?(b(),h(A,{key:0},[c("button",{onClick:n[4]||(n[4]=()=>e.handleNext("shortBreak")),class:"break-btn"},"短休息"),c("button",{onClick:n[5]||(n[5]=()=>e.handleNext("longBreak")),class:"break-btn"},"长休息")],64)):(b(),h("button",{key:1,onClick:n[6]||(n[6]=s=>e.handleNext("pomodoro")),class:"next-btn"},"开始专注"))])])):ee("",!0)],4)}const ve=Y(te,[["render",ue],["__scopeId","data-v-9d69a383"]]);export{ve as default};
