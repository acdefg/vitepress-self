import{_ as P,v as W,q,p as y,h as _,a2 as J,a3 as A,o as u,c as d,j as s,a as f,F as k,t as v,a0 as I,C as M,aa as G,e as S,n as j,N as H}from"./framework.CElktlHO.js";const K={props:{show:Boolean,currentUser:Object},emits:["close","showLogin","update:currentUser"],setup(n,{emit:e}){console.log("RoomModal setup, props:",n);const m=()=>{console.log("RoomModal close called"),e("close")};W(()=>{console.log("RoomModal mounted"),o()});const o=()=>{console.log("Loading room stats");try{const t=JSON.parse(localStorage.getItem("roomStats")||"{}");console.log("Loaded room stats:",t),r.value=t}catch(t){console.error("Error loading room stats:",t),r.value={}}};q(()=>n.show,t=>{console.log("RoomModal show prop changed:",t),t&&o()});const r=y({}),O=_(()=>{var t;return!((t=n.currentUser)!=null&&t.room)||!r.value[n.currentUser.room]?[]:Object.entries(r.value[n.currentUser.room].members).sort(([,i],[,a])=>a-i).map(([i,a])=>[i,isNaN(a)?0:a])}),l=t=>t===0?"gold":t===1?"silver":t===2?"bronze":"",c=t=>{const i=Math.max(...O.value.map(([,a])=>a));return`${t/i*100}%`},b=()=>{const t=prompt("请输入要加入的自习室名称:");if(t){if(!r.value[t]){alert("该自习室不存在");return}n.currentUser.room=t,localStorage.setItem("currentUser",JSON.stringify(n.currentUser)),r.value[t].members[n.currentUser.username]||(r.value[t].members[n.currentUser.username]=0),localStorage.setItem("roomStats",JSON.stringify(r.value)),o(),alert("成功加入自习室！")}},T=()=>{const t=prompt("请输入新自习室名称:");if(!t)return;if(r.value[t]){alert("该自习室已存在");return}if(n.currentUser.room){const a=n.currentUser.room;delete r.value[a].members[n.currentUser.username]}r.value[t]={owner:n.currentUser.username,members:{[n.currentUser.username]:0}},localStorage.setItem("roomStats",JSON.stringify(r.value));const i={...n.currentUser,room:t};localStorage.setItem("currentUser",JSON.stringify(i)),e("update:currentUser",i),o(),alert("成功创建并加入自习室！")},N=async()=>{var g;const t=n.currentUser.room,i=Object.keys(((g=r.value[t])==null?void 0:g.members)||{});if(!i.length||i.length===1){if(!window.confirm("你是自习室最后一名成员，退出后自习室将被删除。是否确认退出？"))return;delete r.value[t]}else if(delete r.value[t].members[n.currentUser.username],R(t)===n.currentUser.username){const C=Object.keys(r.value[t].members)[0];r.value[t].owner=C,alert(`房主身份已转移给 ${C}`)}localStorage.setItem("roomStats",JSON.stringify(r.value));const a={...n.currentUser};delete a.room,localStorage.setItem("currentUser",JSON.stringify(a)),e("update:currentUser",a),o(),alert("已退出自习室！")},L=t=>{n.currentUser.room=t,localStorage.setItem("currentUser",JSON.stringify(n.currentUser)),r.value[t].members[n.currentUser.username]||(r.value[t].members[n.currentUser.username]=0),localStorage.setItem("roomStats",JSON.stringify(r.value)),o(),alert("成功加入自习室！")},x=t=>{if(R(t)!==n.currentUser.username){alert("只有房主可以删除自习室！");return}if(!window.confirm("确定要删除该自习室吗？所有成员将被移出。"))return;Object.keys(r.value[t].members).forEach(g=>{g!==n.currentUser.username&&console.log(`通知 ${g}: 自习室 ${t} 已被房主删除`)}),delete r.value[t],localStorage.setItem("roomStats",JSON.stringify(r.value));const a={...n.currentUser};delete a.room,localStorage.setItem("currentUser",JSON.stringify(a)),e("update:currentUser",a),o(),alert("自习室已删除！")},B=t=>{const i=Object.keys(r.value[t].members).filter(g=>g!==n.currentUser.username);if(i.length===0){alert("没有其他成员可以转让房主身份");return}const a=prompt(`请输入要转让的成员用户名：
可选成员：`+i.join(", "));if(a){if(!i.includes(a)){alert("该用户不在自习室中！");return}r.value[t].owner=a,localStorage.setItem("roomStats",JSON.stringify(r.value)),alert(`已将房主身份转让给 ${a}`),o()}},R=t=>{var i;return((i=r.value[t])==null?void 0:i.owner)||""},h=y(!1),U=y(""),w=y(""),z=_(()=>!w.value||!r.value[w.value]?[]:Object.keys(r.value[w.value].members).filter(t=>t!==n.currentUser.username)),E=t=>{w.value=t,U.value="",h.value=!0},F=()=>{if(!U.value){alert("请选择新房主");return}const t=w.value;r.value[t].owner=U.value,localStorage.setItem("roomStats",JSON.stringify(r.value)),alert(`已将房主身份转让给 ${U.value}`),h.value=!1,o()},V=()=>{e("showLogin")},D=_(()=>{var t;return((t=n.currentUser)==null?void 0:t.room)||null});return{roomStats:r,sortedRoomMembers:O,getRankClass:l,getProgressWidth:c,joinRoom:b,createRoom:T,leaveRoom:N,handleJoin:L,deleteRoom:x,showTransferOwner:B,getRoomOwner:R,close:m,showTransferModal:h,selectedNewOwner:U,availableMembers:z,openTransferModal:E,handleTransferOwner:F,handleLoginClick:V,userCurrentRoom:D}}},Q={class:"modal-dialog modal-xl"},X={class:"modal-content"},Y={class:"modal-header"},Z={class:"modal-body"},$={key:0,class:"auth-prompt"},p={class:"prompt-card"},ee={key:1,class:"room-interface"},se={class:"control-panel"},te={class:"room-status"},oe={class:"current-room"},re={class:"btn-group"},ne={key:1,class:"btn-group"},le={class:"room-list"},ae={class:"section-title"},ie={class:"modal-dialog"},ce={class:"modal-content"},ue={class:"modal-header"},de={class:"modal-body"},me={class:"form-group"},fe=["value"],ve={class:"modal-footer"},be={class:"room-grid"},ge={class:"room-header"},Ue={key:0,class:"owner-tag"},we={class:"room-meta"},ke={class:"member-count"},ye={class:"room-actions"},Se=["onClick"],Oe=["onClick"],Re=["onClick"],he={key:0,class:"ranking-section"},Ce={class:"section-title"},_e={class:"ranking-list"},Me={class:"rank"},je={class:"user-info"},Je={class:"username"},Ie={class:"study-time"},Te={class:"progress"};function Ne(n,e,m,o,r,O){return J((u(),d("div",{class:j(["modal",{show:m.show}]),tabindex:"-1",onClick:e[11]||(e[11]=I((...l)=>o.close&&o.close(...l),["self"]))},[s("div",Q,[s("div",X,[s("div",Y,[e[12]||(e[12]=s("h5",{class:"modal-title"},[s("i",{class:"fas fa-users-classroom me-2"}),f(" 自习室 ")],-1)),s("button",{type:"button",class:"btn-close",onClick:e[0]||(e[0]=l=>n.$emit("close"))})]),s("div",Z,[m.currentUser?(u(),d("div",ee,[s("div",se,[s("div",te,[o.userCurrentRoom?(u(),d(k,{key:0},[s("div",oe,[e[16]||(e[16]=s("i",{class:"fas fa-school me-2"},null,-1)),f(" 当前自习室："+v(o.userCurrentRoom),1)]),s("div",re,[s("button",{class:"btn btn-success btn-create",onClick:e[2]||(e[2]=(...l)=>o.createRoom&&o.createRoom(...l))},e[17]||(e[17]=[s("i",{class:"fas fa-plus-circle me-2"},null,-1),f("新建自习室 ")])),s("button",{class:"btn btn-danger",onClick:e[3]||(e[3]=(...l)=>o.leaveRoom&&o.leaveRoom(...l))},e[18]||(e[18]=[s("i",{class:"fas fa-sign-out-alt me-2"},null,-1),f("退出 ")]))])],64)):(u(),d("div",ne,[s("button",{class:"btn btn-primary btn-join",onClick:e[4]||(e[4]=(...l)=>o.joinRoom&&o.joinRoom(...l))},e[19]||(e[19]=[s("i",{class:"fas fa-door-open me-2"},null,-1),f("加入自习室 ")])),s("button",{class:"btn btn-success btn-create",onClick:e[5]||(e[5]=(...l)=>o.createRoom&&o.createRoom(...l))},e[20]||(e[20]=[s("i",{class:"fas fa-plus-circle me-2"},null,-1),f("新建自习室 ")]))]))])]),s("div",le,[s("h3",ae,[e[24]||(e[24]=s("div",{class:"title-left"},[s("i",{class:"fas fa-list-ol me-2"}),f(" 自习室列表 ")],-1)),o.showTransferModal?(u(),d("div",{key:0,class:"modal transfer-modal",onClick:e[10]||(e[10]=I(l=>o.showTransferModal=!1,["self"]))},[s("div",ie,[s("div",ce,[s("div",ue,[e[21]||(e[21]=s("h5",{class:"modal-title"},"转移房主",-1)),s("button",{type:"button",class:"btn-close",onClick:e[6]||(e[6]=l=>o.showTransferModal=!1)})]),s("div",de,[s("div",me,[e[23]||(e[23]=s("label",null,"选择新房主：",-1)),J(s("select",{"onUpdate:modelValue":e[7]||(e[7]=l=>o.selectedNewOwner=l),class:"form-select"},[e[22]||(e[22]=s("option",{value:""},"请选择",-1)),(u(!0),d(k,null,M(o.availableMembers,l=>(u(),d("option",{key:l,value:l},v(l),9,fe))),128))],512),[[G,o.selectedNewOwner]])])]),s("div",ve,[s("button",{class:"btn btn-secondary",onClick:e[8]||(e[8]=l=>o.showTransferModal=!1)},"取消"),s("button",{class:"btn btn-primary",onClick:e[9]||(e[9]=(...l)=>o.handleTransferOwner&&o.handleTransferOwner(...l))},"确认转移")])])])])):S("",!0)]),s("div",be,[(u(!0),d(k,null,M(o.roomStats,(l,c)=>(u(),d("div",{key:c,class:j(["room-card",{"current-room":m.currentUser.room===c}])},[s("div",ge,[e[25]||(e[25]=s("i",{class:"fas fa-university me-2"},null,-1)),s("h4",null,v(c),1),o.getRoomOwner(c)?(u(),d("span",Ue,v(o.getRoomOwner(c)===m.currentUser.username?"(我是房主)":`(房主: ${o.getRoomOwner(c)})`),1)):S("",!0)]),s("div",we,[s("span",ke,[e[26]||(e[26]=s("i",{class:"fas fa-users me-1"},null,-1)),f(" "+v(Object.keys(l.members).length)+"人 ",1)]),s("div",ye,[m.currentUser.room===c&&o.getRoomOwner(c)===m.currentUser.username?(u(),d(k,{key:0},[s("button",{class:"btn btn-sm btn-warning",onClick:b=>o.openTransferModal(c)},e[27]||(e[27]=[s("i",{class:"fas fa-exchange-alt me-1"},null,-1),f("转让 ")]),8,Se),s("button",{class:"btn btn-sm btn-danger",onClick:b=>o.deleteRoom(c)},e[28]||(e[28]=[s("i",{class:"fas fa-trash-alt me-1"},null,-1),f("解散 ")]),8,Oe)],64)):m.currentUser.room!==c?(u(),d("button",{key:1,class:"btn btn-sm btn-join",onClick:b=>o.handleJoin(c)}," 加入 ",8,Re)):S("",!0)])])],2))),128))])]),m.currentUser.room?(u(),d("div",he,[s("h3",Ce,[e[29]||(e[29]=s("i",{class:"fas fa-trophy me-2"},null,-1)),f(" "+v(m.currentUser.room)+" 学习榜 ",1)]),s("div",_e,[(u(!0),d(k,null,M(o.sortedRoomMembers,([l,c],b)=>(u(),d("div",{key:l,class:"ranking-item"},[s("div",Me,[s("span",{class:j(["rank-badge",o.getRankClass(b)])},v(b+1),3)]),s("div",je,[s("span",Je,v(l),1),s("span",Ie,v(Math.floor(c/60))+"小时"+v(c%60)+"分钟 ",1)]),s("div",Te,[s("div",{class:"progress-bar",style:H({width:o.getProgressWidth(c)})},null,4)])]))),128))])])):S("",!0)])):(u(),d("div",$,[s("div",p,[e[14]||(e[14]=s("i",{class:"fas fa-door-open fa-3x text-primary mb-3"},null,-1)),e[15]||(e[15]=s("h4",{class:"mb-3"},"加入学习社区",-1)),s("button",{class:"btn btn-lg btn-primary",onClick:e[1]||(e[1]=(...l)=>o.handleLoginClick&&o.handleLoginClick(...l))},e[13]||(e[13]=[s("i",{class:"fas fa-sign-in-alt me-2"},null,-1),f("立即登录 ")]))])]))])])])],2)),[[A,m.show]])}const xe=P(K,[["render",Ne],["__scopeId","data-v-82cb9d11"]]);export{xe as default};
